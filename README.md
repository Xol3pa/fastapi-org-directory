# Org Directory API

Асинхронный FastAPI‑сервис со справочником организаций, зданий и видов деятельности.

## Быстрый старт
1. `cp .env.example .env`
2. (опционально) поправьте значения `APP_DATABASE__ASYNC_URL`, `APP_DATABASE__SYNC_URL`, `APP_API_KEY`.
3. `docker-compose up --build`

API доступно на `http://localhost:8000`, документация — `/docs`. Все запросы требуют заголовок `X-API-Key`.

## Локально (без Docker)
```bash
python -m venv .venv && source .venv/bin/activate
pip install -r requirements.txt
alembic upgrade head
uvicorn src.main:app --reload
```

Готово.

## Архитектура

- **Входная точка.** `src/main.py` создаёт приложение через `create_app()` и регистрирует lifespan-хук, который пингует БД (`src/core/startup.py`).
- **Слои API.** Роутеры FastAPI живут в `src/api/routers/*` и зависят от `verify_api_key` + `get_session`. Они не работают напрямую с ORM, а используют доменные сервисы и DTO-мапперы.
- **Сервисный слой.** Файлы `src/services/*` содержат бизнес-операции (поиск организаций, обход дерева активностей, загрузка зданий). Сервисы принимают репозитории через конструктор и в тестах могут подменяться.
- **Репозитории.** В `src/repositories/*` инкапсулированы SQLAlchemy-запросы, загрузка отношений и вся работа с БД. Благодаря этому API и доменные правила не знают о структуре таблиц.
- **DTO / сериализация.** Любые ответы наружу собираются в `src/mappers/*`, которые преобразуют ORM-модели в Pydantic-схемы (`src/schemas/*`). Это гарантирует стабильные контракты API при изменении БД.
- **Конфигурация и инфраструктура.** Настройки (включая строки подключения и API-ключ) лежат в `src/config/settings.py`; подключение к БД и сессии — в `src/db/session.py`. Docker-компоуз поднимает Postgres и само API.

## Используемые паттерны

- **Repository.** `ActivityRepository`, `BuildingRepository`, `OrganizationRepository` скрывают SQL и агрегируют загрузку отношений.
- **Service Layer.** `ActivityService`, `BuildingService`, `OrganizationService` инкапсулируют бизнес-правила и композицию репозиториев, отделяя доменную логику от HTTP.
- **DTO Mapper.** Функции `map_*` в `src/mappers/` отвечают за преобразование ORM → Pydantic, чтобы API-контракты не зависели от моделей БД.
- **Dependency Injection.** FastAPI `Depends` используется для выдачи API-ключа и сессии БД; сервисы создаются через фабрики `_service(session)` и легко заменяются в тестах.
- **Lifespan / Context Manager.** Паттерн применён для управления ресурсами: и приложение, и `get_session()` используют контекстные менеджеры, контролирующие открытие/закрытие соединений.

Такое разделение помогает чётко видеть роль каждой части в продовом сервисе и облегчает расширение (например, добавление Unit of Work, кэшей или фоновых задач).

## Тесты

Локальный запуск unit-тестов:

```bash
pip install ".[dev]"
pytest
```

Тесты покрывают мапперы и ключевую бизнес-логику сервисов, гарантируя корректную сериализацию DTO и расчёт геопоиска.
